<!DOCTYPE html>
<meta charset="utf-8">
<style>

html, body {
  font-family: open-sans, sans-serif, arial;
  font-size: 14px;
}
path {
  fill: #fff;
}
circle {
  fill: #333;
}
text {
  font-size: 8px;
  font-family: open-sans, sans-serif, arial;
}
</style>
<body>
  <h1>PCA and KMeans on historical temprature data</h1>

  <label>Cluster weather data</label><input id="chk" type="checkbox"/>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
<script>

var width = 960,
    height = 500;

var projection = d3.geo.albersUsa()
        .scale(1000)
        .translate([width / 2, height / 2]);

var path = d3.geo.path()
          .projection(projection);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var clusterColors = d3.scale.category10();

var x = d3.scale.linear().range([ 30, width- 30 ]),
    y = d3.scale.linear().range([30, height -30]);

var pcdata, coord, stations;

d3.json("us.topo.json", function(error, topology) {
  if (error) throw error;
  svg.append('g')
     .attr('class', 'map')
     .append("path")
      .datum(topojson.feature(topology, topology.objects.land))
      .attr('stroke', '#ccc')
      .attr("d", path);
      
  d3.csv('coords-us.csv', function(error, cdata) {
    coords = cdata;

    stations = svg.append('g')
      .attr('class','stations')
      .selectAll('.station').data(coords).enter()
      .append('g')
      .attr('transform', function(d) {
        var coord =[-parseFloat(d.Longitude), parseFloat(d.Latitude)];
        var p = projection(coord); 
        return p ? 'translate('+p[0]+' '+p[1]+')' : 'translate(0,0)';
      })
      .attr('id', function(d) { return d.Station.toLowerCase().replace(/[^a-z]/gi,'');});

      stations.append('circle')
      .attr('r', 2)
      .attr('cx', 0)
      .attr('cy', 0); 
      
      stations.append('text')
        .text(function(d) { return d.Station })
        .attr('x', 4)
        .attr('y', 4);
      
  });
  
});

d3.csv('us_pc.csv', function(error, pcd) {
  
  pcdata = pcd;

  x.domain(d3.extent(pcdata, function(d) { return parseFloat(d.PC1); }));
  y.domain(d3.extent(pcdata, function(d) { return parseFloat(d.PC2); }));

});


var showPCData = function() {
        pcdata.forEach(function(station) {
            console.log(station);
            var cId = station.stations.toLowerCase().replace(/[^a-z]/gi,'');
            console.log(cId);
            d3.select('#'+cId).transition().duration(1500)
              .attr('transform', 'translate('+x(parseFloat(station.PC1))+' '+y(parseFloat(station.PC2))+')')
              .attr('fill', clusterColors(station.cluster));
        });
        d3.select('.map path').transition().duration(1500).attr('stroke','#FFF');

}

var showMap = function() {


     stations.transition().duration(1500).attr('transform', function(d) {
        var coord =[-parseFloat(d.Longitude), parseFloat(d.Latitude)];
        var p = projection(coord); 
        return p ? 'translate('+p[0]+' '+p[1]+')' : 'translate(0,0)';
      });
      d3.select('.map path').transition().duration(1500).attr('stroke','#ccc');
}
document.querySelector('#chk').addEventListener('click', function(e) {
  if(e.target.checked) {
    showPCData();
  }
  else {
    showMap();
  }
});


</script>

